<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jastip Terpadu</title>
    <style>
        /* ... (CSS :root, body, container, h1, h2, h3, form, dll tetap sama) ... */
        :root {
            --bg-color: #f4f7f6; --container-bg: #fff; --text-color: #333; --header-color: #2c3e50;
            --card-bg: #f9f9f9; --card-border: #eee; --card-border-left: #3498db;
            --menu-item-bg: #ecf0f1; --accordion-bg: #34495e; --accordion-hover: #2c3e50;
            --button-bg: #3498db; --button-hover: #2980b9; --edit-btn-bg: #95a5a6;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 800px; margin: 0 auto; background-color: var(--container-bg); padding: 25px 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        h1, h2, h3 { color: var(--header-color); }
        h1 { cursor: pointer; } h3.category-title { border-bottom: 2px solid var(--menu-item-bg); padding-bottom: 10px; margin-top: 30px; }
        form { display: flex; flex-direction: column; gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 8px; font-weight: 600; color: var(--header-color); }
        input[type="text"], input[type="url"], input[type="number"] { padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; width: 100%; box-sizing: border-box; background-color: var(--container-bg); color: var(--text-color); }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .menu-item { display: flex; align-items: center; background-color: var(--menu-item-bg); padding: 10px; border-radius: 5px; }
        button { padding: 15px; background-color: var(--button-bg); color: white; border: none; border-radius: 5px; font-size: 18px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: var(--button-hover); }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #order-list { margin-top: 40px; }
        .order-card { background-color: var(--card-bg); border: 1px solid var(--card-border); border-left: 5px solid var(--card-border-left); padding: 15px; margin-bottom: 10px; border-radius: 5px; position: relative; }
        .order-card h3 { margin-top: 0; color: #2980b9; }
        .order-card p { margin: 8px 0; word-break: break-all; }
        .order-card .timestamp { font-size: 0.8em; color: #7f8c8d; text-align: right; }
        .edit-btn, .save-btn { font-size: 12px; padding: 5px 10px; position: absolute; top: 15px; right: 15px; background-color: var(--edit-btn-bg); }
        .save-btn { background-color: #27ae60; }
        .accordion { background-color: var(--accordion-bg); color: white; cursor: pointer; padding: 18px; width: 100%; border: none; text-align: left; outline: none; font-size: 18px; transition: 0.4s; margin-top: 10px; border-radius: 5px; }
        .accordion.active, .accordion:hover { background-color: var(--accordion-hover); }
        .accordion:after { content: '\\002B'; color: #fff; font-weight: bold; float: right; margin-left: 5px; }
        .accordion.active:after { content: "\\2212"; }
        .panel { padding: 18px; background-color: var(--container-bg); max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out; border-radius: 0 0 5px 5px; border: 1px solid #ddd; border-top: none; }
        .item-checklist { margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px; }
        .item-checklist .checklist-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; }
        .item-checklist label { font-weight: normal; }
        .item-checklist input:disabled + label { color: #888; }
        .item-cancelled label { text-decoration: line-through; color: #e74c3c; }
        .cancel-btn { background-color: #e74c3c; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; line-height: 20px; text-align: center; cursor: pointer; padding: 0; }
        .finance-info { background-color: #ecf0f1; padding: 10px; border-radius: 5px; margin-top: 15px; }
        .finance-info p { margin: 5px 0; }
        .dark-mode {
            --bg-color: #121212; --container-bg: #1e1e1e; --text-color: #e0e0e0; --header-color: #ffffff;
            --card-bg: #2a2a2a; --card-border: #444; --card-border-left: #3498db;
            --menu-item-bg: #333; --accordion-bg: #383838; --accordion-hover: #444;
        }
        .dark-mode .finance-info { background-color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="main-title">üìù List Jastip Terpadu</h1>
        <!-- Form dan elemen lainnya tetap sama -->
        <form id="jastip-form">
            <div class="form-group"><label for="nama">Nama Kamu:</label><input type="text" id="nama" name="nama" placeholder="Contoh: Budi" required></div>
            <div class="form-group" id="menu-kategori-container"><label>Pilih Titipan (boleh lebih dari satu):</label></div>
            <div class="form-group"><label for="opsi-lain">Opsi Lain:</label><input type="text" id="opsi-lain" name="opsi-lain" placeholder="Contoh: Apa saja yang penting ayam"></div>
            <div class="form-group"><label for="total-pesanan">Jumlah Item:</label><input type="number" id="total-pesanan" name="total-pesanan" placeholder="Contoh: 3" required></div>
            <div class="form-group"><label for="bukti-transfer">Link Bukti Transfer:</label><input type="url" id="bukti-transfer" name="bukti-transfer" placeholder="https://..."></div>
            <button type="submit" id="submit-button">Kirim Titipan</button>
        </form>
        <div id="message"></div>
        <div id="order-list">
            <h2>Daftar Titipan Saat Ini</h2>
            <div id="loading">Memuat daftar titipan...</div>
            <div id="list-container"></div>
        </div>
    </div>
    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyvF-0bkwt95zcNv8P3FkH2Rq0v9NkWcqfIQ4TqtBB2vzNiLSH2QM65kNAKKubtJYjlng/exec";
        const ADMIN_PASSWORD = "RAHASIA123";
        const HARGA_PER_ITEM = 10000;
        let isAdminMode = false;
        
        // ... (kode menuItems tetap sama)
        const menuItems = {
            "Nasi & Lauk Utama": ["Pernasian (random)", "Nasi bakar", "Nasi kuning", "Nasi goreng", "Nasi bali", "Sate ayam", "Taichan", "Cakalang", "Katsu", "Chicken steak"],
            "Pasta & Makanan Barat": ["Lasagna", "Spaghetti Carbonara", "Spaghetti Bolognese", "Spaghetti Aglio Olio", "Spaghetti Mentai", "Macaroni Mentai", "Macaroni Schotel", "Burger", "Hotdog", "Zuppa soup", "Sandwich"],
            "Camilan Gurih": ["Pempek", "Dimsum Mentai", "Pangsit chili oil", "Toppoki", "Sushi", "Takoyaki", "Risol", "Pastel", "Spring roll ala vietnam", "Makaroni Mentai"],
            "Kue & Jajanan Manis": ["Nona manis/kue talam", "Bapao", "Bapia kacang ijo", "Apem", "Roti manis", "Onde-onde", "Putu ayu", "Kue sus", "Dadar gulung", "Bugis mandi", "Donat (gula/meses)", "Bomboloni", "Mochi"],
            "Dessert & Minuman": ["Grilled chicken salad", "Salad sayur", "Salad buah", "Jasuke", "Setup roti (pandan/coklat)", "Bubur campur manis", "Pudding", "Buko pandan", "Buah potong", "Manggo sticky rice"]
        };

        // ... (semua konstanta elemen DOM tetap sama)
        const form = document.getElementById('jastip-form');
        const listContainer = document.getElementById('list-container');
        const loadingDiv = document.getElementById('loading');

        function renderMenu() { /* ... (kode renderMenu tetap sama, salin dari versi sebelumnya) ... */ }
        async function fetchOrders() { /* ... (kode fetchOrders tetap sama, salin dari versi sebelumnya) ... */ }

        function displayOrders(orders) {
            const formatRupiah = (angka) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
            
            const groupedByDate = orders.reduce((acc, order) => {
                const date = order.Timestamp.substring(0, 10);
                if (!acc[date]) acc[date] = [];
                acc[date].push(order);
                return acc;
            }, {});

            const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));
            let html = '';
            sortedDates.forEach(date => {
                const displayDate = new Date(date).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const totalItems = groupedByDate[date].reduce((sum, order) => sum + parseInt(order['Total Pesanan'] || 0, 10), 0);
                html += `<button class="accordion" data-date="${date}">${displayDate} (Total ${totalItems} Item)</button><div class="panel">`;
                
                groupedByDate[date].sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
                
                groupedByDate[date].forEach(order => {
                    const displayTime = new Date(order.Timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                    
                    const titipanItems = order.Titipan ? order.Titipan.split(', ') : [];
                    const selesaiItems = order['Item Selesai'] ? order['Item Selesai'].split(',') : [];
                    const dibatalkanItems = order['Item Dibatalkan'] ? order['Item Dibatalkan'].split(',') : [];

                    // --- Kalkulasi Keuangan ---
                    const totalAwal = (parseInt(order['Total Pesanan'] || 0)) * HARGA_PER_ITEM;
                    const jumlahItemValid = titipanItems.length - dibatalkanItems.length;
                    const totalAkhir = jumlahItemValid * HARGA_PER_ITEM;
                    const jumlahRefund = totalAwal - totalAkhir > 0 ? totalAwal - totalAkhir : 0;

                    let checklistHtml = '<div class="item-checklist">';
                    titipanItems.forEach(item => {
                        const isChecked = selesaiItems.includes(item);
                        const isCancelled = dibatalkanItems.includes(item);
                        const isDisabled = !isAdminMode || isCancelled;
                        
                        checklistHtml += `
                            <div class="checklist-item ${isCancelled ? 'item-cancelled' : ''}">
                                <div>
                                    <input type="checkbox" class="item-status-cb" value="${item}" ${isChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                                    <label>${item}</label>
                                </div>
                                ${isAdminMode && !isCancelled ? `<button class="cancel-btn" data-item="${item}">X</button>` : ''}
                            </div>
                        `;
                    });
                    checklistHtml += '</div>';
                    
                    html += `
                        <div class="order-card" data-id="${order.ID}">
                            <button class="edit-btn">Edit</button>
                            <h3>${order.Nama}</h3>
                            <p><strong>Titipan:</strong></p>${checklistHtml} 
                            <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">
                            <div class="finance-info">
                                <p>Total Awal: <strong>${formatRupiah(totalAwal)}</strong></p>
                                <p>Total Akhir (setelah pembatalan): <strong>${formatRupiah(totalAkhir)}</strong></p>
                                <p style="color: #e74c3c;">Jumlah Refund: <strong>${formatRupiah(jumlahRefund)}</strong></p>
                            </div>
                            <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;">
                            <p class="editable-opsi"><strong>Opsi Lain:</strong> <span>${order['Opsi Lain'] || '-'}</span></p>
                            <p class="editable-total" style="display:none;"><strong>Jumlah Item:</strong> <span>${order['Total Pesanan'] || '0'}</span></p>
                            <p class="editable-bukti"><strong>Bukti TF:</strong> <span>${order['Bukti Transfer'] ? `<a href="${order['Bukti Transfer']}" target="_blank">Lihat Bukti</a>` : 'Belum ada'}</span></p>
                            <p class="timestamp">Dipesan jam: ${displayTime}</p>
                        </div>`;
                });
                html += `</div>`;
            });
            listContainer.innerHTML = html || '<p>Belum ada titipan.</p>';
        }

        listContainer.addEventListener('click', async function(e) {
            // ... (logika accordion, edit, save tetap sama) ...
            
            // --- LOGIKA BARU UNTUK TOMBOL CANCEL ---
            if (e.target.classList.contains('cancel-btn')) {
                const itemToCancel = e.target.dataset.item;
                if (!confirm(`Anda yakin ingin membatalkan item: "${itemToCancel}"?`)) return;

                const card = e.target.closest('.order-card');
                const orderId = card.dataset.id;
                
                // Ambil daftar item yang sudah dibatalkan sebelumnya
                let cancelledItems = [];
                const cancelledP = card.querySelector('.item-cancelled'); // Cari elemen yang sudah ada
                if (cancelledP) {
                     // Ini perlu logika yang lebih baik, kita akan refresh saja
                }

                // Untuk simple, kita fetch ulang data lalu tambahkan
                // Atau cara lebih cepat:
                e.target.parentElement.classList.add('item-cancelled');
                e.target.parentElement.querySelector('input[type="checkbox"]').disabled = true;
                e.target.style.display = 'none';

                // Ambil semua item yang sekarang dibatalkan
                let currentCancelled = Array.from(card.querySelectorAll('.item-cancelled label')).map(label => label.textContent);
                
                try {
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'cancel_item',
                            id: orderId,
                            cancelledItems: currentCancelled
                        })
                    });
                    await fetchOrders(); // Refresh seluruh daftar untuk kalkulasi ulang
                } catch (error) {
                    console.error('Gagal membatalkan item:', error);
                    alert('Gagal membatalkan item.');
                }
            }
        });
        
        // ... (kode admin mode, form submit, DOMContentLoaded, dll tetap sama, salin dari versi sebelumnya)
    </script>
</body>
</html>
