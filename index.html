<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jastip Terpadu</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 25px 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        h1, h2 { text-align: center; color: #2c3e50; }
        h3.category-title { color: #34495e; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-top: 30px; }
        form { display: flex; flex-direction: column; gap: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 8px; font-weight: 600; color: #34495e; }
        input[type="text"], input[type="url"], input[type="number"] { padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; width: 100%; box-sizing: border-box; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .menu-item { display: flex; align-items: center; background-color: #ecf0f1; padding: 10px; border-radius: 5px; }
        .menu-item input[type="checkbox"] { margin-right: 10px; width: 18px; height: 18px; }
        button { padding: 15px; background-color: #3498db; color: white; border: none; border-radius: 5px; font-size: 18px; font-weight: bold; cursor: pointer; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #order-list { margin-top: 40px; }
        .order-card { background-color: #f9f9f9; border: 1px solid #eee; border-left: 5px solid #3498db; padding: 15px; margin-bottom: 10px; border-radius: 5px; position: relative; }
        .order-card h3 { margin-top: 0; color: #2980b9; }
        .order-card p { margin: 8px 0; word-break: break-all; }
        .order-card .timestamp { font-size: 0.8em; color: #7f8c8d; text-align: right; }
        .edit-btn, .save-btn { font-size: 12px; padding: 5px 10px; position: absolute; top: 15px; right: 15px; background-color: #95a5a6; }
        .save-btn { background-color: #27ae60; }
        #loading, #message { text-align: center; font-size: 1.2em; padding: 20px; }
        .accordion { background-color: #34495e; color: white; cursor: pointer; padding: 18px; width: 100%; border: none; text-align: left; outline: none; font-size: 18px; transition: 0.4s; margin-top: 10px; border-radius: 5px; }
        .accordion.active, .accordion:hover { background-color: #2c3e50; }
        .accordion:after { content: '\\002B'; color: #fff; font-weight: bold; float: right; margin-left: 5px; }
        .accordion.active:after { content: "\\2212"; }
        .panel { padding: 18px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out; border-radius: 0 0 5px 5px; border: 1px solid #ddd; border-top: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù List Jastip Terpadu</h1>
        <form id="jastip-form">
            <div class="form-group"><label for="nama">Nama Kamu:</label><input type="text" id="nama" name="nama" placeholder="Contoh: Budi" required></div>
            
            <div class="form-group" id="menu-kategori-container">
                <label>Pilih Titipan (boleh lebih dari satu):</label>
                <!-- Kategori menu akan digenerate oleh JS di sini -->
            </div>

            <div class="form-group"><label for="opsi-lain">Opsi Lain (jika titipan utama tidak ada):</label><input type="text" id="opsi-lain" name="opsi-lain" placeholder="Contoh: Apa saja yang penting ayam"></div>
            <!-- BARU: Input untuk Total Pesanan -->
            <div class="form-group"><label for="total-pesanan">Jumlah Pesanan:</label><input type="number" id="total-pesanan" name="total-pesanan" placeholder="Contoh: 3" required></div>
            <div class="form-group"><label for="bukti-transfer">Link Bukti Transfer (opsional):</label><input type="url" id="bukti-transfer" name="bukti-transfer" placeholder="https://... (contoh: link Google Drive)"></div>
            <button type="submit" id="submit-button">Kirim Titipan</button>
        </form>
        <div id="message"></div>
        <div id="order-list">
            <h2>Daftar Titipan Saat Ini</h2>
            <div id="loading">Memuat daftar titipan...</div>
            <div id="list-container"></div>
        </div>
    </div>
    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwVd6BgWjVuoU2KSYbU-4yyxAKeA1Db5fZjy2IBxWZnrirAHPIKLQWk7jf2VCikRYgyTw/exec";
        
        // BARU: Menu dikelompokkan berdasarkan kategori
        const menuItems = {
            "Nasi & Lauk Utama": ["Pernasian (random)", "Nasi bakar", "Nasi kuning", "Nasi goreng", "Nasi bali", "Sate ayam", "Taichan", "Cakalang", "Katsu", "Chicken steak"],
            "Pasta & Makanan Barat": ["Lasagna", "Spaghetti Carbonara", "Spaghetti Bolognese", "Spaghetti Aglio Olio", "Spaghetti Mentai", "Macaroni Mentai", "Macaroni Schotel", "Burger", "Hotdog", "Zuppa soup", "Sandwich"],
            "Camilan Gurih": ["Pempek", "Dimsum Mentai", "Pangsit chili oil", "Toppoki", "Sushi", "Takoyaki", "Risol", "Pastel", "Spring roll ala vietnam", "Makaroni Mentai"],
            "Kue & Jajanan Manis": ["Nona manis/kue talam", "Bapao", "Bapia kacang ijo", "Apem", "Roti manis", "Onde-onde", "Putu ayu", "Kue sus", "Dadar gulung", "Bugis mandi", "Donat (gula/meses)", "Bomboloni", "Mochi"],
            "Dessert & Minuman": ["Grilled chicken salad", "Salad sayur", "Salad buah", "Jasuke", "Setup roti (pandan/coklat)", "Bubur campur manis", "Pudding", "Buko pandan", "Buah potong", "Manggo sticky rice"]
        };

        const form = document.getElementById('jastip-form');
        const submitButton = document.getElementById('submit-button');
        const messageDiv = document.getElementById('message');
        const listContainer = document.getElementById('list-container');
        const loadingDiv = document.getElementById('loading');
        const menuKategoriContainer = document.getElementById('menu-kategori-container');

        // BARU: Fungsi render menu dengan kategori
        function renderMenu() {
            let html = '';
            for (const kategori in menuItems) {
                html += `<h3 class="category-title">${kategori}</h3>`;
                html += `<div class="menu-grid">`;
                menuItems[kategori].forEach(item => {
                    const id = item.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase();
                    html += `
                        <div class="menu-item">
                            <input type="checkbox" id="${id}" name="titipan" value="${item}">
                            <label for="${id}">${item}</label>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            menuKategoriContainer.innerHTML += html;
        }

        async function fetchOrders() {
            const openAccordions = new Set();
            document.querySelectorAll('.accordion.active').forEach(acc => openAccordions.add(acc.dataset.date));
            loadingDiv.style.display = 'block';
            try {
                const response = await fetch(SCRIPT_URL);
                const result = await response.json();
                listContainer.innerHTML = '';
                if (result.data && result.data.length > 0) {
                    displayOrders(result.data);
                } else {
                    listContainer.innerHTML = '<p>Belum ada titipan. Jadilah yang pertama!</p>';
                }
                document.querySelectorAll('.accordion').forEach(acc => {
                    if (openAccordions.has(acc.dataset.date)) {
                        acc.classList.add('active');
                        const panel = acc.nextElementSibling;
                        panel.style.maxHeight = panel.scrollHeight + "px";
                    }
                });
            } catch (error) {
                console.error('Error fetching orders:', error);
                listContainer.innerHTML = '<p style="color: red;">Gagal memuat daftar titipan.</p>';
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

      function displayOrders(orders) {
    const groupedByDate = orders.reduce((acc, order) => {
        const date = order.Timestamp.substring(0, 10);
        if (!acc[date]) acc[date] = [];
        acc[date].push(order);
        return acc;
    }, {});

    const sortedDates = Object.keys(groupedByDate).sort((a, b) => new Date(b) - new Date(a));
    let html = '';
    sortedDates.forEach(date => {
        const displayDate = new Date(date).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        // ======================================================================
        // INI BAGIAN LOGIKA BARU YANG ANDA MINTA
        //
        // Alih-alih menghitung jumlah pesanan (orderCount), kita sekarang menjumlahkan
        // nilai dari field "Total Pesanan" untuk semua pesanan pada tanggal ini.
        const totalItems = groupedByDate[date].reduce((sum, order) => {
            // Ambil nilai 'Total Pesanan', ubah ke angka. Jika kosong/tidak valid, anggap 0.
            const itemCount = parseInt(order['Total Pesanan'] || 0, 10);
            return sum + itemCount;
        }, 0); // Mulai menjumlahkan dari 0
        // ======================================================================

        // Gunakan 'totalItems' yang sudah dijumlahkan di header accordion
        html += `<button class="accordion" data-date="${date}">${displayDate} (Total ${totalItems} Item)</button>`;
        html += `<div class="panel">`;
        
        groupedByDate[date].sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
        
        groupedByDate[date].forEach(order => {
            const buktiLink = order['Bukti Transfer'] ? `<a href="${order['Bukti Transfer']}" target="_blank" rel="noopener noreferrer">Lihat Bukti</a>` : 'Belum ada';
            const displayTime = new Date(order.Timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            
            // PERBAIKAN: Menampilkan 'Total Pesanan' sebagai angka biasa, bukan mata uang (Rp)
            const jumlahPesanan = order['Total Pesanan'] || '0';

            html += `
                <div class="order-card" data-id="${order.ID}">
                    <button class="edit-btn">Edit</button>
                    <h3>${order.Nama}</h3>
                    <p><strong>Titipan:</strong> ${order.Titipan}</p>
                    <p class="editable-opsi"><strong>Opsi Lain:</strong> <span>${order['Opsi Lain'] || '-'}</span></p>
                    <p class="editable-total"><strong>Jumlah Pesanan:</strong> <span>${jumlahPesanan}</span></p>
                    <p class="editable-bukti"><strong>Bukti TF:</strong> <span>${buktiLink}</span></p>
                    <p class="timestamp">Dipesan jam: ${displayTime}</p>
                </div>
            `;
        });
        html += `</div>`;
    });
    
    // Juga perbaiki logika edit agar tidak lagi memformat sebagai mata uang
    // Ini sudah otomatis teratasi karena saat "Simpan" ditekan, fungsi fetchOrders -> displayOrders akan dipanggil ulang dengan format yang benar.
    // Namun, saat tombol "Edit" ditekan, kita juga perlu perbaiki. Cari event listener di bawah.

    listContainer.innerHTML = html || '<p>Belum ada titipan.</p>';
}

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitButton.disabled = true; submitButton.textContent = 'Mengirim...'; messageDiv.textContent = '';
            const selectedItems = Array.from(document.querySelectorAll('input[name="titipan"]:checked')).map(cb => cb.value);
            if (selectedItems.length === 0) {
                messageDiv.textContent = 'Pilih minimal satu titipan!'; messageDiv.style.color = 'red';
                submitButton.disabled = false; submitButton.textContent = 'Kirim Titipan';
                return;
            }
            // BARU: Ambil data dari input Total Pesanan
            const data = {
                nama: document.getElementById('nama').value,
                titipan: selectedItems.join(', '),
                opsiLain: document.getElementById('opsi-lain').value,
                totalPesanan: document.getElementById('total-pesanan').value,
                buktiTransfer: document.getElementById('bukti-transfer').value
            };
            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
                const result = await response.json();
                if (result.status === "success") {
                    messageDiv.textContent = result.message; messageDiv.style.color = 'green';
                    form.reset();
                    await fetchOrders();
                } else { throw new Error(result.message); }
            } catch (error) {
                console.error('Error submitting form:', error);
                messageDiv.textContent = 'Gagal mengirim titipan: ' + error.message; messageDiv.style.color = 'red';
            } finally {
                submitButton.disabled = false; submitButton.textContent = 'Kirim Titipan';
            }
        });

        listContainer.addEventListener('click', async function(e) {
            if (e.target.classList.contains('accordion')) {
                e.target.classList.toggle('active');
                const panel = e.target.nextElementSibling;
                panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight + "px";
            }
           if (e.target.classList.contains('edit-btn')) {
                const card = e.target.closest('.order-card');
                const opsiP = card.querySelector('.editable-opsi span');
                const totalP = card.querySelector('.editable-total span');
                const buktiP = card.querySelector('.editable-bukti span');
                const buktiLink = buktiP.querySelector('a');
                
                // Kode yang ada saat ini sudah benar karena hanya mengambil angkanya
                const currentTotal = totalP.textContent.replace(/[^0-9]/g, '');

                opsiP.innerHTML = `<input type="text" value="${opsiP.textContent === '-' ? '' : opsiP.textContent}">`;
                // Ganti label di dalam kartu pesanan saat diedit
                totalP.innerHTML = `<input type="number" value="${currentTotal}">`;
                buktiP.innerHTML = `<input type="url" value="${buktiLink ? buktiLink.href : ''}">`;
                
                e.target.textContent = 'Simpan';
                e.target.classList.remove('edit-btn'); e.target.classList.add('save-btn');
            } 
            else if (e.target.classList.contains('save-btn')) {
                e.target.disabled = true; e.target.textContent = '...';
                const card = e.target.closest('.order-card');
                const data = {
                    action: 'update',
                    id: card.dataset.id,
                    opsiLain: card.querySelector('.editable-opsi input').value,
                    totalPesanan: card.querySelector('.editable-total input').value, // BARU
                    buktiTransfer: card.querySelector('.editable-bukti input').value
                };
                try {
                    const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
                    const result = await response.json();
                    if (result.status !== 'success') throw new Error(result.message);
                    await fetchOrders();
                } catch (error) {
                    alert('Gagal menyimpan perubahan: ' + error.message);
                    e.target.disabled = false; e.target.textContent = 'Simpan';
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            renderMenu();
            fetchOrders();
        });
    </script>
</body>
</html>
